<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="utf-8">
<title>图块拼接</title>
<link rel="icon" type="image/x-icon" href="assets/resources/image/方块拼图.png" />
<style type="text/css">
body {
	margin: auto;
	color: gray;
	/* background-color: #002040; */
}
#myCanvas {
	width: 1px;
	height: 1px;
	background-size: 16px 16px;
	background-image: -webkit-gradient(linear, 0 0, 100% 100%, color-stop(.25, #ccc), color-stop(.25, transparent), to(transparent)),-webkit-gradient(linear, 0 100%, 100% 0, color-stop(.25, #ccc), color-stop(.25, transparent), to(transparent)),-webkit-gradient(linear, 0 0, 100% 100%, color-stop(.75, transparent), color-stop(.75, #ccc)),-webkit-gradient(linear, 0 100%, 100% 0, color-stop(.75, transparent), color-stop(.75, #ccc));
}
.img {
	position: absolute;
}
#refer {
	position: relative;
}
#toolbar {
	height: 44px;
	line-height: 44px;
}
#inputFile {
	width: 70px;
}
</style>
<script>
var canvas, ct; // 画布和其上下文
var files = []; // 文件
var srcData = []; // 原图的base64编码
var imagesData = []; // 图片实体数组
var images = {}; // 图片实体对象, 图片的文件名作为key
var pointer = 0; // 数组的索引
var prefix = ''; // 图片文件名的前两个字符(序号)
var xBasic = 0, xUpper = 0, yBasic = 0, yUpper = 0;

// 执行入口
window.onload = function() {
	canvas = document.getElementById('myCanvas');
	canvas.width = canvas.clientWidth;
	canvas.height = canvas.clientHeight;
	ct = canvas.getContext('2d');
	var inputFile = document.getElementById('inputFile');
	inputFile.onchange = function(e) {
		files = e.target.files;
		if (files.length) {
			pointer = 0;
			srcData = [];
			funcLoadFile();
		}
	};
	var btnSave = document.getElementById('btnSave');
	btnSave.onclick = funcSave;
	var btnClear = document.getElementById('btnClear');
	btnClear.onclick = funcClear;
	var btnEnter = document.getElementById('btnEnter');
	btnEnter.onclick = function() {
		xBasic = 0;
		xUpper = 0;
		yBasic = yUpper;
	};
};

// 载入原图
function funcLoadFile() {
	var file = files[pointer];
	var reader = new FileReader();
	reader.onload = function(e) {
		var src = e.target.result;
		srcData.push(src);
		pointer += 1;
		if (pointer < files.length) funcLoadFile();
		else {
			pointer = 0;
			imagesData = [];
			images = {};
			funcPrepareImage();
		}
	}
	reader.readAsDataURL(file);
}

// 准备原图(生成图片dom)
function funcPrepareImage() {
	var domImg = document.createElement('img');
	domImg.className = 'img';
	domImg.style.left = '0px';
	domImg.style.top = '0px';
	var name = files[pointer].name;
	name = name.split('.')[0];
	imagesData.push(domImg);
	images[name] = domImg;

	domImg.src = srcData[pointer];
	domImg.onload = function() {
		if (name.substr(0, 2) !== prefix) {
			prefix = name.substr(0, 2);
			xBasic = xUpper;
		}

		domImg.style.left = xBasic + 'px';
		domImg.style.top = yBasic + 'px';

		if (name[2] > 0) {
			var previousName = name[2] - 1;
			previousName = name.substr(0, 2) + previousName + name[3];
			var previousImg = images[previousName];
			if (previousImg) {
				var x = parseInt(previousImg.style.left) + previousImg.width;
				domImg.style.left = x + 'px';
				if (x + domImg.width > xUpper) xUpper = x + domImg.width;
			}
		}

		if (name[3] > 0) {
			if (name[2] > 0) {
				var previousName = name[2] - 1;
				previousName = name.substr(0, 2) + previousName + name[3];
				var previousImg = images[previousName];
				if (previousImg) {
					domImg.style.top = previousImg.style.top;
				}
			} else {
				var previousName = name[3] - 1;
				previousName = name.substr(0, 3) + previousName;
				var previousImg = images[previousName];
				if (previousImg) {
					var y = parseInt(previousImg.style.top) + previousImg.height;
					domImg.style.top = y + 'px';
					if (y + domImg.height > yUpper) yUpper = y + domImg.height;
				}
			}
		}

		var refer = document.getElementById('refer');
		refer.appendChild(domImg);
		pointer += 1;
		if (pointer < srcData.length) funcPrepareImage();
		else funcDrawImage();
	};
}

// 画上原图
function funcDrawImage() {
	var canvas2 = document.createElement('canvas');
	var ct2 = canvas2.getContext('2d');
	var offsetX = 0, offsetY;

	for (var i = 0; i < files.length; i += 1) {
		var name = files[i].name;
		name = name.split('.')[0];
		var img = images[name];
		var imgX = parseInt(img.style.left), imgY = parseInt(img.style.top);
		if (i === 0) {
			offsetX = imgX;
			offsetY = imgY;
		}
		imgX -= offsetX;
		imgY -= offsetY;
		ct2.drawImage(img, imgX, imgY);
	}

	// 抠图(去掉背景色)
	var imgData = ct2.getImageData(0, 0, canvas2.width, canvas2.height);
	var data = imgData.data;
	var r0 = data[0], g0 = data[1], b0 = data[2]; // 以左上角的像素作为透明

	for (var i = 0; i < data.length; i += 4) {
		var r = data[i];
		var g = data[i + 1];
		var b = data[i + 2];
		if (r === r0 && g === g0 && b === b0) data[i + 3] = 0;
	}

	// 修剪或扩展画布
	if (xUpper > canvas.width || yUpper > canvas.height) {
		var imgDataBefore = ct.getImageData(0, 0, canvas.width, canvas.height);
		if (xUpper > canvas.width) {
			canvas.style.width = xUpper + 'px';
			canvas.width = xUpper;
		}
		if (yUpper > canvas.height) {
			canvas.style.height = yUpper + 'px';
			canvas.height = yUpper;
		}
		// 注意: 重新调整画布尺寸后会造成画布里的图片丢失, 因此以下这句进行恢复
		ct.putImageData(imgDataBefore, 0, 0);
	}

	var img = imagesData[0];
	var imgX = parseInt(img.style.left), imgY = parseInt(img.style.top);
	ct.putImageData(imgData, imgX, imgY);
}

// 保存拼接好的图
function funcSave() {
	var dataUrl = canvas.toDataURL('image/png');
	var a = document.createElement('a');
	a.href = dataUrl;
	a.download = funcNow();
	a.click();
}

// 清除画布里的图片
function funcClear() {
	ct.clearRect(0, 0, canvas.width, canvas.height);
	var refer = document.getElementById('refer');
	refer.textContent = '';
	prefix = '';
	xBasic = 0;
	xUpper = 0;
	yBasic = 0;
	yUpper = 0;
}

// 返回当前时间
function funcNow() {
	var date = new Date();
	//var yy = date.getFullYear();
	var mm = date.getMonth()+1;
	var dd = date.getDate();
	
	var hh = date.getHours();
	var m2 = date.getMinutes();
	//var ss = date.getSeconds();
	
	mm = (mm<10) ? '0'+mm : ''+mm;
	dd = (dd<10) ? '0'+dd : ''+dd;
	hh = (hh<10) ? '0'+hh : ''+hh;
	m2 = (m2<10) ? '0'+m2 : ''+m2;
	//ss = (ss<10) ? '0'+ss : ''+ss;
	
	var dateStr = mm + dd;
	dateStr += hh + m2;
	return dateStr;
}
</script>
</head>

<body>
<div id="toolbar">
	<input id="inputFile" type="file" accept="image/x-png" multiple="multiple" />
	<input id="btnSave" type="button" value="保存" />
	<input id="btnClear" type="button" value="清除" />
	<input id="btnEnter" type="button" value="换行" />
</div>
<div>
	<canvas id="myCanvas"></canvas>
</div>
<div id="refer"></div>
</body>
</html>
